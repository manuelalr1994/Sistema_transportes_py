{% extends 'home/home_facturacion.html' %}
{% load static %}

{% block titulo %} Aplicación de factura {% endblock titulo %}

{% block contenido %}
<div class="modalContainer">
    <div class="modal modalWidth modalClose">
        <p class="close marginClose" id="closeModal">X</p>
        <img src="" alt="">
        <div class="modalTextos">
            <div class="contenedorRegistro_empleados">
                <form>
                    <div class="panel panel_default">
                        <div class="panel_heading">
                            <h2>Generar factura</h2>
                        </div>
                        <div class="panel_body">
                            <div class="grupo_formulario roll">
                                <div class="colum_input colum_inputVar">
                                    <label>No. de remisión:</label>
                                    <select name="" id="remision" class="form_control">
                                        <option value="">-----------------------</option>
                                        {% for remision in lista_remisiones %}
                                            <option value="{{ remision.pk }}">{{ remision.codigo }} | ${{ remision.importe }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="colum_input colum_inputVar">
                                    <label>No. de factura:</label>
                                    <input id="factura" class="form_control" type="number" value="">
                                </div>
                            </div>
                            <div class="grupo_formulario roll">
                                <div class="colum_input colum_inputVar">
                                    <label>Fecha:</label>
                                    <input id="fecha" class="form_control" type="text" disabled>
                                </div>
                                <div class="colum_input colum_inputVar">
                                    <label>Campo Agricola:</label>
                                    <input id="campo_agricola_modal" class="form_control" type="text" disabled value="">
                                </div>
                            </div>
                            <div class="grupo_formulario roll">
                                <div class="colum_input colum_inputVar">
                                    <label>Ubicacion:</label>
                                    <input id="ubicacion" class="form_control" type="text" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel_default">
                        <div class="panel_body">
                            <div class="grupo_formulario roll">
                                <div class="overflow_modal" style="height: 15%;">
                                    <table id="tabla_fechas" class="tab_mod_modal">
                                        <thead class="thead_registro colorModal">
                                            <tr>
                                                <th>Semanas</th>
                                                <th>Concepto</th>
                                                <th>Tipo de pago</th>
                                                <th>Importe</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabla_abonos">
                                            <tr>
                                                <td><input class="form_control" type="text" disabled value="Semana 1"
                                                        style="text-align: center; padding: 0px 12px;"></td>
                                                <td><input class="form_control" type="text" disabled
                                                        value="21/05/2020 - 28/05/2020" style="text-align: center; padding: 0px 12px;">
                                                </td>
                                                <td><input class="form_control" type="text" disabled value="Pago total"
                                                        style="text-align: center; padding: 0px 12px;"></td>
                                                <td><input class="form_control" type="text" disabled value="$125,130.00"
                                                        style="text-align: center; padding: 0px 12px; font-weight: 700;"></td>
                                            </tr>
                                            <tr>
                                                <td><input class="form_control" type="text" disabled value="Semana 1"
                                                        style="text-align: center; padding: 0px 12px;"></td>
                                                <td><input class="form_control" type="text" disabled
                                                        value="21/05/2020 - 28/05/2020" style="text-align: center; padding: 0px 12px;">
                                                </td>
                                                <td><input class="form_control" type="text" disabled value="Pago total"
                                                        style="text-align: center; padding: 0px 12px;"></td>
                                                <td><input class="form_control" type="text" disabled value="$125,130.00"
                                                        style="text-align: center; padding: 0px 12px; font-weight: 700;"></td>
                                            </tr>
                                            <tr>
                                                <td><input class="form_control" type="text" disabled value="Semana 1"
                                                        style="text-align: center; padding: 0px 12px;"></td>
                                                <td><input class="form_control" type="text" disabled
                                                        value="21/05/2020 - 28/05/2020" style="text-align: center; padding: 0px 12px;">
                                                </td>
                                                <td><input class="form_control" type="text" disabled value="Pago total"
                                                        style="text-align: center; padding: 0px 12px;"></td>
                                                <td><input class="form_control" type="text" disabled value="$125,130.00"
                                                        style="text-align: center; padding: 0px 12px; font-weight: 700;"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="grupo_formulario roll" style="flex-direction: row-reverse;">
                                        <div class="colum_input">
                                            <label>Total:</label>
                                            <input id="total_remision" class="form_control" type="number" value="800" disabled
                                                style="text-align: center; padding: 0px; font-size: 16px; font-weight: 700;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="botones">
                        <input type="button" id="boton_submit" class="btn seleccion_ch save disable-select"
                            value="Generar">
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modalContainerDos">
    <div class="modalDos modalCloseDos">
        <p class="close paddingClose marginClose" id="closeModalDos">X</p>
        <img src="" alt="">
        <div class="modalTextos">
            <div class="contenedorRegistro_empleados">
                <form>
                    <div class="panel panel_default">
                        <div class="panel_heading">
                            <h2>Facturación</h2>
                        </div>
                        <div class="panel_body">
                            <div id="tabla_remision" class="grupo_formulario">
                                <div class="colum_input varWidth textP">
                                    <label>Pago total en semana 1:</label>
                                    <p>$100.00</p>
                                </div>
                                <div class="colum_input varWidth textP">
                                    <label>Pago total en semana 2:</label>
                                    <p>$200.00</p>
                                </div>
                                <div class="colum_input varWidth textP">
                                    <label>Abono en semana 3:</label>
                                    <p>$1,000,300.00</p>
                                </div>

                                <div class="colum_input varWidth textP">
                                    <label>Total:</label>
                                    <p>$600.00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->

<section class="listas">
    <div class="listas_recientes">
        <div class="encabezado_listas" id="var_encabezado">
            <h2 class="titulo" id="var_titulo">Aplicación de factura</h2>
        </div>
        <div class="contenedorRegistro_empleados">
            <form id="formulario_bitacora" method="post"
                action="{% url 'fletes:procesos:capturas_fleteras:reporteBitacora' %}">{% csrf_token %}
                <div class="panel panel_default panelModCamiones">
                    <div class="modCamiones">
                        <b>Campo Agricola:</b>
                        <input type="text" id="campo_agricola" class="form_control"
                        value="{{ campo_agricola.nombre }}" campo_agricola="{{ campo_agricola.pk }}" disabled>
                    </div>
                    <div class="modCamiones">
                        <b>Desde:</b>
                        <input id="fecha_inicio" type="date" class="form_control" required>

                        <b>Hasta:</b>
                        <input id="fecha_final" type="date" class="form_control" required>

                    </div>
                </div>

                <div>
                    <div class="containerImprimir">
                        <div class="imprimir colorImprimir" id="contenido_tabla_capturas">
                            <input id="abrirModal" class="imprimirInput varImprimir" type="button"
                                value="Generar factura">
                        </div>
                    </div>
                    <div class="containerImprimir">
                        <div class="imprimir colorImprimirVar">
                            <input type="button" id="reporte_bitacora" value="Imprimir listado">
                        </div>
                    </div>
                </div>

                <div class="panel panel_default fontSize">
                    <div class="panel_body">
                        <div class="grupo_formulario roll">
                            <div class="overflow_mod_cam" id="contenido_tabla_capturas_dos">
                                <table id="tabla_fechas" class="tab_mod_camiones">
                                    <thead>
                                        <tr>
                                            <th>Concepto</th>
                                            <th>N° Semana</th>
                                            <th>Semana</th>
                                            <th>Remisión</th>
                                            <th>Fecha</th>
                                            <th>Factura</th>
                                            <th>Fecha</th>
                                            <th>Horas fletes</th>
                                            <th>Costo maquila</th>
                                            <th>Importe maquila</th>
                                            <th>Abonos</th>
                                            <th>Saldo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="consultaRemision">
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td><b>REMISIÓN</b></td>
                                            <td class="bgBlue"></td>
                                            <td></td>
                                            <td>100012</td>
                                            <td>24/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td class="bgLight"></td>
                                            <td class="bgBlue">
                                                $ 585,000.00
                                                <input type="button" value="Desglose" class="btnDesgloce">
                                            </td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td><b>REMISIÓN</b></td>
                                            <td class="bgBlue"></td>
                                            <td></td>
                                            <td>100012</td>
                                            <td>24/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td class="bgLight"></td>
                                            <td class="bgBlue">
                                                $ 585,000.00
                                                <input type="button" value="Desglose" class="btnDesgloce">
                                            </td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>
                                        <tr>
                                            <td>Maquila</td>
                                            <td class="bgBlue">1</td>
                                            <td>28/12/2021 - 03/01/2022</td>
                                            <td></td>
                                            <td></td>
                                            <td>856.00</td>
                                            <td>270.00</td>
                                            <td class="bgLight">231,120.00</td>
                                            <td class="bgBlue"></td>
                                            <td>$ 231,120.00</td>
                                        </tr>

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

        </div>
    </div>
</section>


<script src="../../../../static/js/modal.js"></script>
<script src="../../../../static/js/modalDos.js"></script>
<script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>

<script>

    $(document).ready(function(){

        // --------------------- FILTRADO DE DATOS POR RANGO DE SEMANAS ---------------------------
        $('#fecha_inicio, #fecha_final').change(function() {
            var campo_agricola_id = $('#campo_agricola').attr('campo_agricola')
            var fecha_inicio = $('#fecha_inicio').val()
            var fecha_final = $('#fecha_final').val()

            if(campo_agricola_id.length > 0 && fecha_inicio.length > 0 && fecha_final.length > 0){
                $.ajax({ 
                    url: "{% url 'facturacion:procesos:asignar_factura:cargarListaFacturas' %}",
                    data: {
                        'campo_agricola' : campo_agricola_id,
                        'fecha_inicio' : fecha_inicio,
                        'fecha_final' : fecha_final
                    },
                    success: function (data) {
                        $('#consultaRemision').html('')
                        $('#consultaRemision').html(data)
                    }
                });
            }

        });


        // --------------------- DESARROLLO DE BOTONES CON SUS DATOS ------------------------------

        let lista_abrir = document.getElementById ("consultaRemision");
        lista_abrir.addEventListener("click", function(e){
            const elemento_accionado = e.target;
            console.log('entre al target')

            if (elemento_accionado.matches(".btnDesgloce")){
                console.log('entre al btn')
                remision_id = elemento_accionado.getAttribute("remision")

                $.ajax({ 
                    url: "{% url 'facturacion:procesos:asignar_factura:cargarDesglose' %}",
                    data: {
                        'remision':remision_id
                    },
                    success: function (data) {

                        console.log('sexo')
                        console.log(data)
                        
                        // Mandamos los datos al Modal
                        $("#tabla_remision").html(data)

                    }
                });

            }

        });


        // --------------------- FUNCIONAMIENTO DE MODAL GENERACION DE REMISION ----------------------------
        $('#remision').change( function(){

            remision = $('#remision').val()

            if(remision.length > 0){

                $.ajax({ 
                    url: "{% url 'facturacion:procesos:asignar_factura:cargarRemision' %}",
                    data: {
                        'remision':remision
                    },
                    success: function (data) {

                        console.log(data)

                        // ------ Mandamos los datos al Modal ------

                        console.log(data.campo_agricola)

                        // Mandamos la informacion de la remision
                        $("#fecha").prop("value", data.fecha)
                        $("#campo_agricola_modal").prop("value", data.campo_agricola)
                        $("#ubicacion").prop("value", data.ubicacion)
                        html_abonos = ''
                        total_remision = 0
                        lista_abonos = data.lista_abonos

                        // Transformamos el tipo de una sola letra (como se guarda en la base de datos) a algo legible
                        for (abono of lista_abonos){
                            if (abono.tipo == 't'){
                                abono.tipo = 'Pago Total'
                            }else if (abono.tipo == 'a'){
                                abono.tipo = 'Abono'
                            }
                        }

                        // Mandamos informacion a la tabla de abonos
                        for (abono of lista_abonos){

                            str = '<tr>\
                            <td><input class="form_control" type="text" disabled value="Semana '+abono.semana+'"\
                                    style="text-align: center; padding: 0px 12px;"></td>\
                            <td><input class="form_control" type="text" disabled\
                                    value="'+abono.fecha+'" style="text-align: center; padding: 0px 12px;">\
                            </td>\
                            <td><input class="form_control" type="text" disabled value="'+abono.tipo+'"\
                                    style="text-align: center; padding: 0px 12px;"></td>\
                            <td><input class="form_control" type="text" disabled value="$'+abono.importe+'"\
                                    style="text-align: center; padding: 0px 12px; font-weight: 700;"></td>\
                            </tr>'

                            html_abonos = html_abonos + str
                            total_remision = total_remision + parseFloat(abono.importe)

                        }

                        $('#tabla_abonos').html(html_abonos)
                        $('#total_remision').prop('value', total_remision)

                    }
                });

            }else {

                if(!remision.length > 0){
                    alert("Debe seleccionar un campo agricola")
                }

            }
        })

        $('#boton_submit').click(function() {

            url = '{% url "facturacion:procesos:asignar_factura:estadoCuentaFacturas" %}'
            remision = $('#remision').val()
            codigo_factura = $('#factura').val()

            if (remision.length > 0 && codigo_factura.length > 0){

                console.log(remision)
                console.log(codigo_factura)

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        'remision' : remision,
                        'codigo_factura' : codigo_factura,
                    },
                    success: function (data) { 
                        if (data['exitoso']){
                            window.location = url
                        }
                        else {
                            alert(data['error'])
                        }
                    },
                    error: function(jqXHR, estado, error) {
                        $("#error").html('<p style="color: red;">Hubo un error en el servidor</p>');
                    }
                });
            }

        });


    })

</script>

{% endblock contenido %}